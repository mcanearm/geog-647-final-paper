---
title: 'Back to the Future: Insights into Public Transit Service through the Lens of Historical Streetcar Routes'
author:
  - name: Matt McAnear
    email: mmcanear@nevada.unr.edu
    affiliation: University of Nevada, Reno
abstract: >
  At its height, Milwaukee's streetcar system was an integral part of the transportation system. Like 
  most American cities, the streetcar was dismanlted and replaced with buses after WWII.
  This paper examines the question of who would be served by the Milwaukee trolley
  system were it not demolished. As of today, modern bus lines run along and beyond the historical
  lines, exceeding service levels in both population and geographic extent. Historical routes in 
  Milwaukee do not offer any significantly better or worse level of service. Just as importantly,
  busy historical trolley routes remain the busiest routes of today. While reimplemntation of the 1938 
  trolley network as a light rail system would potentially provide some benefits to the city of Milwaukee,
  these benefits would be isolated to light rail as a mode of transport, and not due to the 
  particular effectiveness of the network.
bibliography: references.bib
csl: acm-sig-proceedings.csl
output: rticles::acm_article
---


```{r setup, echo=FALSE, message=FALSE}
suppressPackageStartupMessages(library(sf))
suppressPackageStartupMessages(library(sp))
suppressPackageStartupMessages(library(ggplot2))
suppressPackageStartupMessages(library(data.table))
suppressPackageStartupMessages(library(rmarkdown))
suppressPackageStartupMessages(library(knitr))
knitr::opts_chunk$set(echo = FALSE, cache = TRUE, dev="png")
options(scipen=100)
```



```{r raw_data_in, echo=FALSE, message=FALSE, warning=FALSE}
void <- capture.output(allBlocks <- st_read('../data/paper-data/milwaukee-csa-blocks/milwaukee-blocks.shp'))
allBlocks$area <- st_area(allBlocks)

# we are removing the largest five blocks, since they are 100% on water with no population and 
# make the maps weird
rm_block_id <- allBlocks[order(allBlocks$area, decreasing = TRUE), ][1:5, ]$gid 
milwaukee_blocks <- allBlocks[-which(allBlocks$gid %in% rm_block_id), ]

# get routes
void <- capture.output(trolleyRoutes <- st_read('../data/paper-data/trolley-routes/trolley-routes.shp'))
void <- capture.output(busRoutes <- st_read('../data/paper-data/bus-routes/bus-routes.shp'))
busRoutes$transport <- 'Bus'
trolleyRoutes$transport <- 'Trolley'

# find intersection of the routes and census blocks
trolley_blocks <- st_intersection(allBlocks, st_buffer(trolleyRoutes, 1000))
bus_blocks <- st_intersection(allBlocks, st_buffer(busRoutes, 1000))

# now not route by route
uniqueTrolleyBlocks <- st_intersection(allBlocks, st_union(st_buffer(trolleyRoutes, 1000)))
uniqueBusBlocks <- st_intersection(allBlocks, st_union(st_buffer(busRoutes, 1000)))
uniqueTrolleyBlocks$transport <- 'Trolley'
uniqueTrolleyBlocks$lineCount <- nrow(trolleyRoutes)
uniqueBusBlocks$transport <- 'Bus'
uniqueBusBlocks$lineCount <- nrow(busRoutes)

# function for adjusting population
adjustPopulation <- function(intersectionDF) {
  area_pct_vect <- as.numeric(st_area(intersectionDF)/intersectionDF$area)
  adj_pop <- as.integer(round(area_pct_vect * intersectionDF$pop10, 0))
  adj_housing <- as.integer(round(area_pct_vect * intersectionDF$housing10, 0))
  
  # return the original data frame wiht the adjusted values appended
  intersectionDF$area_pct <- area_pct_vect
  intersectionDF$pop10_adj <- adj_pop
  intersectionDF$housing10_adj <- adj_housing
  intersectionDF
}

dataSets <- list(trolley_blocks, bus_blocks, uniqueTrolleyBlocks, uniqueBusBlocks)
names(dataSets) <- c('trolley_routes', 'bus_routes', 'trolley_total', 'bus_total')
adjustedData <- lapply(dataSets, adjustPopulation)
```



# Introduction

* Like other systems in the early 20th century, Milwaukee's streetcars were operated
by a private entity.

* How did the layout of cities contribute to the success/failure of the streetcar?
Unlike other American cities, Milwaukee's transit utilization was slightly lower than other major
American cities[@simon_city-building_1996, pp. 100]. EXPAND

* How many people were served by streetcars? What was its modeshare?
In spite of this, Milwaukee served a large number of people[@moore_state_2014]
* Milwaukee faced distinctive policital and legal battles for administrating an effective
streetcar system.

# Methodology

The goal of this study is to estimate the population served by trolley routes 
in historical Milwaukee. The trolley system in Milwaukee was not static
over its 50+ year history. The system generally expanded since its founding
in CITATION + YEAR FOUNDED until 1938, declining afterward. 
To estimate our population served, we will use the system in 1938; this is when
the system was at its maximum length. 


NOTE: Investigate over-estimate of population along routes by assuming
you can get on at any stop

One large assumption of the current analysis is that a person can conceivably
get on a bus or could have gotten on a trolley at any point along its route. This
doesn't matter as much for trolleys, but for buses this can lead to an especially
large over-estimate of population, particular in the case of the northbound
bus route.

Note: clean up / regenerate the data used if possible, using only QGis.

Trolley routes were imported from KML to QGis, and then uploaded to PostGreSQL 
for further analysis. A shapefile of bus routes in Milwaukee was loaded into 
QGis and then put into PostgreSQL as well. Each file was converted to a UTM 
projection in QGis and finally output to standard ESRI shapefiles to use in the 
final analysis. Similarly, bus routes were downloaded from Milwaukee's open 
data portal and imported into QGis. Then, once converted to a UTM coordinate system
they were exported to a shapefile.

For each route system, we create a buffer of 1km around each transit route. With
these buffers we find the intersection of the buffer polygons and census blocks.
For any partial overlap, we calculate the percentage of overlap using a ratio
of the polygon intersection and the original census block area. Assuming
a uniform population within each census block, we multiply the 
population and number of households by this ratio to find an estimated population
served by a transit route.

This analysis is performed twice. First, we do this on each individual trolley
route and bus route. This allows us to estimate the total population served by 
each route. However, this creates an issue of multiple counting - a particular
block (and often is) served by multiple bus and trolley lines. These estimates
are useful for comparing line by line, but not for aggregation.

To examine fully aggregated results, we combine the route geometries into a single
geom and take the union of each route. Once this is complete, we repeat the 
route by route analysis for the aggregated polygon. This yields an estimate 
of population served without the problem of multi counting.


# Results

Simple overlays of the historical streetcar routes and modern bus routes show 
a strong overlap between the systems. In fact, there are no census blocks in Milwaukee
that are covered by a historical trolley route but not by a modern bus route.
Buses completely supplanted the streetcar in Milwaukee. This makes Milwaukee similar
to other cities once home to extensive streetcar systems [CITATION].

Modern bus routes not only cover the older trolley routes, but extend well past them.
Bus routes extend well outside the urban core. Still, the Milwaukee MSA
extends much further than even the furthest flung bus routes.

Compare this to historical population for trolley routes.

```{r populationService, fig.width=8, fig.height=10, fig.cap = "Current bus routes and 1938 trolley routes of Milwaukee laid over 2010 census blocks. All census blocks in the Milwaukee CSA are considered, but this set is truncated for legibility.", results='asis', fig.pos='here'}

trolleyDT <- as.data.table(adjustedData$trolley_routes)
busDT <- as.data.table(adjustedData$bus_routes)
setnames(busDT, 'gid.1', 'route_id')
transportRouteDT <- rbindlist(list(busDT, trolleyDT), use.names = TRUE, fill = TRUE)
routeDT <- transportRouteDT[, .(
  'Pop Served' = sum(pop10_adj),
  'Housing Units Served' = sum(housing10_adj)
), by = c('transport', 'route_id')]


# clean up into a mergable format (there has to be a better way to do this)
busRouteDT <- as.data.table(busRoutes[, c('gid', 'geometry', 'transport')])
trolleyRouteDT <- as.data.table(trolleyRoutes[, c('route_id', 'geometry', 'transport')])
setnames(busRouteDT, colnames(trolleyRouteDT))
trolleyRouteDT$geometry <- st_cast(trolleyRouteDT$geometry, 'MULTILINESTRING')

routeGeoms <- rbindlist(list(trolleyRouteDT, busRouteDT))
routePopDT <- merge(routeDT, as.data.table(routeGeoms), 
                    by.x = c('route_id', 'transport'), by.y = c('route_id', 'transport'), all.x = TRUE)

routePopDT <- st_as_sf(routePopDT)
bbox <- st_bbox(busRouteDT$geometry)
ggplot(data = routePopDT, aes(color = transport)) +
  scale_color_brewer(palette = 'Dark2') +
  geom_sf(data = milwaukee_blocks, lwd = 0.05, alpha=0.5, fill='White', 
          color = 'Black', inherit.aes = FALSE) +
  theme_bw() +
  theme(legend.position = 'top', panel.grid.major = element_blank(), text = element_text(size = 14)) +
  guides(color = guide_legend(title = 'Route Type')) +
  scale_x_continuous(limits = c(bbox['xmin'], bbox['xmax'])) +
  scale_y_continuous(limits = c(bbox['ymin'], bbox['ymax'])) +
  geom_sf() 

```

```{r total_transport_counts}
allTransportBlocks <- as.data.table(rbind(adjustedData$trolley_total, adjustedData$bus_total))
transportSummary <- allTransportBlocks[, .(
  'Block Count' = .N,
  'Population' = sum(pop10_adj),
  'Pop/Line' = sprintf('%i', round(sum(pop10_adj)/max(lineCount), 0))
), by = c('transport')]
setnames(transportSummary, 'transport', 'Route Type')
kable(transportSummary, format = 'latex', caption = 'Total population served by trolley network of 1938 and modern bus routes. Population per line is rounded to nearest integer.')
```


Big finding - there are no current census blocks that would be served by trolleys that are not already served by buses.

```{r lorenz_distributions, fig.cap="Lorenz Curves by travel mode. This methodology double counts population that is served by multiple lines, but does so equally across modes. Trolley lines are slightly more concentrated."}

plotData <- as.data.table(routePopDT)

dissimilarityIndex <- function(x) {
  pct_y <- x/sum(x)
  pct_x <- 1/length(x)
  0.5 * sum(abs(pct_y - pct_x))
}

lorenzData <- plotData[
  ][order(`Pop Served`), .SD, by = 'transport'
  ][, .(
    'id_pct' = 1:.N,
    'pop_pct' = cumsum(`Pop Served`)/sum(`Pop Served`),
    'total_count' = .N
  ), by = c('transport')
  ][, .(transport, 'id_pct' = id_pct/total_count, pop_pct)
]

indices <- plotData[, dissimilarityIndex(`Pop Served`), by = 'transport']
indexText <- sprintf(
  'Dissimilarity Indices:\nBus - %0.03f\nTrolley - %0.03f', 
  indices[transport == 'Bus', V1], 
  indices[transport == 'Trolley', V1]
)
ggplot(data = lorenzData, aes(x=id_pct, y = pop_pct, col = transport)) +
  geom_line() +
  scale_color_brewer(palette = 'Dark2') +
  scale_x_continuous(labels = scales::percent_format()) +
  scale_y_continuous(labels = scales::percent_format()) +
  theme_bw() +
  theme(axis.title = element_blank()) +
  guides(color = guide_legend(title = 'Mode')) +
  annotate(geom = 'text', x = 0.2, y = 0.6, label=indexText, hjust=0)
```



```{r bus_trolley_plot, fig.width=8, fig.height=10, echo = FALSE, fig.cap="Map of the 4 counties comprising the Milwaukee MSA. The majority of the MSA by land area is not served by public transit into Milwaukee proper. The 1938 trolley network serves Milwaukee proper, while the buses serve only the outer city and inner suburbs.", message=FALSE}
uniqueBusBlocks <- adjustedData$bus_total
uniqueTrolleyBlocks <- adjustedData$trolley_total
both <- intersect(uniqueBusBlocks$gid, uniqueTrolleyBlocks$gid)
onlyBus <- setdiff(uniqueBusBlocks$gid, uniqueTrolleyBlocks$gid)
onlyTrolley <- setdiff(uniqueTrolleyBlocks$gid, uniqueBusBlocks$gid)

# assign groupings according to what transport is accessible
milwaukee_blocks$transport <- 'None'
milwaukee_blocks$transport[which(milwaukee_blocks$gid %in% onlyBus)] <- 'Bus Only'
milwaukee_blocks$transport[which(milwaukee_blocks$gid %in% onlyTrolley)] <- 'Trolley'
milwaukee_blocks$transport[which(milwaukee_blocks$gid %in% both)] <- 'Trolley + Bus'


bothBlocks <- uniqueTrolleyBlocks[which(uniqueTrolleyBlocks$gid %in% both), ]
bothBlocks$transport <- 'Both'
busOnlyBlocks <- uniqueBusBlocks[which(uniqueBusBlocks$gid %in% onlyBus), ]
busOnlyBlocks$transport <- 'Bus Only'

fullSet <- rbind(bothBlocks, busOnlyBlocks)

p <- ggplot(data = milwaukee_blocks, aes(fill = transport, color=transport)) +  
  geom_sf(lwd=0.05, color='black') +
  theme_bw() +
  theme(legend.position = 'top', axis.text = element_blank(), axis.ticks = element_blank(),
        panel.grid.major = element_blank(), text = element_text(size = 14)) +
  guides(fill = guide_legend(title = 'Transport Type')) +
  scale_fill_brewer(palette = 'Dark2')
p

```



* What extent does each public transit type cover Milwaukee?
* Population served by:
  * Buses
  * Trolleys
* What percentage of the population of Milwaukee area used to be served by public transit?
  * Consider TOTAL population of Milwaukee in 1938 or 1940
  * Compare against TOTAL Milwaukee MSA in 2010
  * Plot Lorentz curve for concentration amount routes
  * Predict higher concentration for bus routes

# Discussion

When considering these historical streetcar lines, there are two ways to consider them. First,
we may examine the role of old streetcars in the context of a modern population. Next, we may
also consider a modern light rail system overlaid upon the historical streetcar system.

* What were the findings?
* What conclusions can we draw about the layout of cities and the requirements of new light rail projects?
* In what ways would historical routes provide higher or lower levels of service in modern context?

# Conclusion
* Quick restatement and wrap up.

# References
