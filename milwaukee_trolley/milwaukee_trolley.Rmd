---
title: 'Back to the Future: Insights into Public Transit Service through the Lens of Historical Streetcar Routes'
author:
  - name: Matt McAnear
    email: mmcanear@nevada.unr.edu
    affiliation: University of Nevada, Reno
abstract: >
  At its height, Milwaukee's streetcar system was an integral part of the transportation system. Like 
  most American cities, the streetcar was dismanlted and replaced with buses after WWII.
  This paper examines the question of who would be served by the Milwaukee trolley
  system were it not demolished. As of today, modern bus lines run along and beyond the historical
  lines, exceeding service levels in both population and geographic extent. Historical routes in 
  Milwaukee do not offer any significantly better or worse level of service. Just as importantly,
  busy historical trolley routes remain the busiest routes of today. While reimplemntation of the 1917 
  trolley network as a light rail system would potentially provide some benefits to the city of Milwaukee,
  these benefits would be isolated to light rail as a mode of transport, and not due to the 
  particular effectiveness of the network.
bibliography: references.bib
csl: acm-sig-proceedings.csl
output: rticles::acm_article
---


```{r setup, echo=FALSE, message=FALSE}
suppressPackageStartupMessages(library(sf))
suppressPackageStartupMessages(library(sp))
suppressPackageStartupMessages(library(ggplot2))
suppressPackageStartupMessages(library(data.table))
suppressPackageStartupMessages(library(rmarkdown))
suppressPackageStartupMessages(library(knitr))
knitr::opts_chunk$set(echo = FALSE, cache = TRUE, dev="png")
options(scipen=100)
```



```{r raw_data_in, echo=FALSE, message=FALSE, warning=FALSE}
void <- capture.output(allBlocks <- st_read('../data/paper-data/milwaukee-csa-blocks/milwaukee-blocks.shp'))
allBlocks$area <- st_area(allBlocks)

# we are removing the largest five blocks, since they are 100% on water with no population and 
# make the maps weird
rm_block_id <- allBlocks[order(allBlocks$area, decreasing = TRUE), ][1:5, ]$gid 
milwaukee_blocks <- allBlocks[-which(allBlocks$gid %in% rm_block_id), ]

# get routes
void <- capture.output(trolleyRoutes <- st_read('../data/paper-data/trolley-routes/1917/routes.shp'))
void <- capture.output(busRoutes <- st_read('../data/paper-data/bus-routes/bus-routes.shp'))
busRoutes$transport <- 'Bus'
trolleyRoutes$transport <- 'Trolley'
trolleyRoutes$len <- st_length(trolleyRoutes)
busRoutes$len <- st_length(busRoutes)

# find intersection of the routes and census blocks
trolley_blocks <- st_intersection(allBlocks, st_buffer(trolleyRoutes, 1000))
bus_blocks <- st_intersection(allBlocks, st_buffer(busRoutes, 1000))

# now not route by route
uniqueTrolleyBlocks <- st_intersection(allBlocks, st_union(st_buffer(trolleyRoutes, 1000)))
uniqueBusBlocks <- st_intersection(allBlocks, st_union(st_buffer(busRoutes, 1000)))
uniqueTrolleyBlocks$transport <- 'Trolley'
uniqueTrolleyBlocks$lineCount <- nrow(trolleyRoutes)
uniqueBusBlocks$transport <- 'Bus'
uniqueBusBlocks$lineCount <- nrow(busRoutes)

# function for adjusting population
adjustPopulation <- function(intersectionDF) {
  area_pct_vect <- as.numeric(st_area(intersectionDF)/intersectionDF$area)
  adj_pop <- as.integer(round(area_pct_vect * intersectionDF$pop10, 0))
  adj_housing <- as.integer(round(area_pct_vect * intersectionDF$housing10, 0))
  
  # return the original data frame wiht the adjusted values appended
  intersectionDF$area_pct <- area_pct_vect
  intersectionDF$pop10_adj <- adj_pop
  intersectionDF$housing10_adj <- adj_housing
  intersectionDF
}

dataSets <- list(trolley_blocks, bus_blocks, uniqueTrolleyBlocks, uniqueBusBlocks)
names(dataSets) <- c('trolley_routes', 'bus_routes', 'trolley_total', 'bus_total')
adjustedData <- lapply(dataSets, adjustPopulation)
```



# Introduction

The privately-owned Milwaukee Electric Railway & Light Company (TMER\&L Co.) purchased several smaller
railway companies in Milwaukee to become the first city-wide trolley system[@noauthor_milwaukee_nodate-1]. 
The history of Milwaukee's streetcar largely mirrors
the history of other streetcar systems. Milwaukee's streetcar history differed from comparable cities
due to population distribution, compact city development, and the inability of lower class
citizens to afford fares. For these reasons, the streetcar network focused service 
on the downtown area and less on outlying areas[@simon_city-building_1996].

In spite of its lower than average utilization at the turn of the century, it is important to recognize
that the Milwaukee streetcar system reamined an essential part of the transportation network, especially
later into the 20th century. According to a 1928 report, streetcars comprised 5% of vehicles entering the city but over 47% of passengers; by comparison, automobiles comprised 77% of all vehicles, 
but only 45% of passengers[@moore_state_2014].

This level of ridership would not be sustained, however. In March of 1958, the streetcar system was
scrapped, finally succumbing to a combination of "(1) consumer preference, ...; (2) the capitalistic 
ambitions of pro-roads industrialists; (3) federal economic incentives, ...; 
and (4) simple (myopic) planning preference[,]" in addition to legal issues and constraints specific 
to Milwaukee[@moore_state_2014].

The national dismantling of streetcar systems is associated (and rightly so) with the emergence
of the private automobile as the principle form of transit. But do the routes that once served so many
people on streetcars remain important into the future? Is it the case that all public transit was dismantled,
or rather, that old trolley lines were replaced with buses, retaining the level of service? To answer these
queestions, we will overlay the historical trolley routes of Milwaukee over census blocks
from the 2010 census to estimate the total population served by current bus routes and historical 
trolleys.

# Methodology

The trolley system in Milwaukee was not static the system generally expanded since its founding
until the early 20th century declining thereafter. To estimate our population served, 
we will use the system in 1917; this is when the system was at its maximum length. 

It was important to compare historical transit routes against a modern analogue, and for this
we used the bus routes published by the city of Milwaukee in their open data portal[@noauthor_mclio_nodate].
While the new bus routes were easy to find from a well-maintained public source, there is no such 
central repository for historical trolley routes. Digitization of these streetcar routes is 
often left to the individual researcher through manual mapping from historical images. 
In the case of Milwaukee, the original KML file used for this project was manully created by 
re-tracing routes in Google Maps for a blog post about the new Milwaukee trolley 
"The Hop[@joe_powell_historical_2015];" their source was a personal website[@bill_vandervoort_chicago_nodate].
Maps in both locations visually align well with a newspaper publication about the history of 
the streetcar[@mikkelson_look_nodate]. It would be ideal to have a scholarly source for the maps,
but the data in question is difficult to come by. Still, the alignment between two
separate sources from different authors validates that the maps provided in the KML are of a 
high enough quality to use with caution.

One large assumption of the current analysis is that a person can conceivably
get on a bus or could have gotten on a trolley at any point along its route. This
doesn't matter as much for trolleys, but for buses this can lead to an especially
large over-estimate of population, particular in the case of the northbound
bus route.

Trolley routes were imported from KML to QGis, and then uploaded to PostGreSQL 
for further analysis. A shapefile of bus routes in Milwaukee was loaded into 
QGis and then put into PostgreSQL as well. Each file was converted to a UTM 
projection in QGis and finally output to standard ESRI shapefiles to use in the 
final analysis. These files are saved as part of the code for the project. 

```{r populationService, fig.width = 4, fig.height = 7, fig.cap = "Current bus routes and 1917 trolley routes of Milwaukee laid over 2010 census blocks. All census blocks in the Milwaukee CSA are considered, but this set is truncated for legibility.", results='asis', fig.pos='here'}

trolleyDT <- as.data.table(adjustedData$trolley_routes)
busDT <- as.data.table(adjustedData$bus_routes)
setnames(busDT, 'gid.1', 'route_id')
transportRouteDT <- rbindlist(list(busDT, trolleyDT), use.names = TRUE, fill = TRUE)
routeDT <- transportRouteDT[, .(
  'Pop Served' = sum(pop10_adj),
  'Housing Units Served' = sum(housing10_adj)
), by = c('transport', 'route_id')]


# clean up into a mergable format (there has to be a better way to do this)
busRouteDT <- as.data.table(busRoutes[, c('gid', 'geometry', 'transport')])
trolleyRouteDT <- as.data.table(trolleyRoutes[, c('route_id', 'geometry', 'transport')])
setnames(busRouteDT, colnames(trolleyRouteDT))
trolleyRouteDT$geometry <- st_cast(trolleyRouteDT$geometry, 'MULTILINESTRING')

routeGeoms <- rbindlist(list(trolleyRouteDT, busRouteDT))
routePopDT <- merge(routeDT, as.data.table(routeGeoms), 
                    by.x = c('route_id', 'transport'), by.y = c('route_id', 'transport'), all.x = TRUE)

routePopDT <- st_as_sf(routePopDT)
bbox <- st_bbox(busRouteDT$geometry)
ggplot(data = routePopDT, aes(color = transport)) +
  scale_color_brewer(palette = 'Dark2') +
  geom_sf(data = milwaukee_blocks, lwd = 0.05, alpha=0.5, fill='White', 
          color = 'Black', inherit.aes = FALSE) +
  theme_bw() +
  theme(legend.position = 'top', panel.grid.major = element_blank(), text = element_text(size = 12)) +
  guides(color = guide_legend(title = 'Route Type')) +
  scale_x_continuous(limits = c(bbox['xmin'], bbox['xmax'])) +
  scale_y_continuous(limits = c(bbox['ymin'], bbox['ymax'])) +
  geom_sf() 

```


For each route system, we create a buffer of 1km around each transit route. With
these buffers we find the intersection of the buffer polygons and census blocks.
For any partial overlap, we calculate the percentage of overlap using a ratio
of the polygon intersection and the original census block area. Assuming
a uniform population within each census block, we multiply the 
population and number of households by this ratio to find an estimated population
served by a transit route.

```{r bus_trolley_plot, echo = FALSE, fig.cap="Map of the 4 counties comprising the Milwaukee MSA. The majority of the MSA by land area is not served by public transit into Milwaukee proper. The 1917 trolley network serves Milwaukee proper, while the buses serve only the outer city and inner suburbs.", fig.pos='here', message=FALSE}
uniqueBusBlocks <- adjustedData$bus_total
uniqueTrolleyBlocks <- adjustedData$trolley_total
both <- intersect(uniqueBusBlocks$gid, uniqueTrolleyBlocks$gid)
onlyBus <- setdiff(uniqueBusBlocks$gid, uniqueTrolleyBlocks$gid)
onlyTrolley <- setdiff(uniqueTrolleyBlocks$gid, uniqueBusBlocks$gid)

# assign groupings according to what transport is accessible
milwaukee_blocks$transport <- 'None'
milwaukee_blocks$transport[which(milwaukee_blocks$gid %in% onlyBus)] <- 'Bus Only'
milwaukee_blocks$transport[which(milwaukee_blocks$gid %in% onlyTrolley)] <- 'Trolley'
milwaukee_blocks$transport[which(milwaukee_blocks$gid %in% both)] <- 'Trolley + Bus'


bothBlocks <- uniqueTrolleyBlocks[which(uniqueTrolleyBlocks$gid %in% both), ]
bothBlocks$transport <- 'Both'
busOnlyBlocks <- uniqueBusBlocks[which(uniqueBusBlocks$gid %in% onlyBus), ]
busOnlyBlocks$transport <- 'Bus Only'

fullSet <- rbind(bothBlocks, busOnlyBlocks)

p <- ggplot(data = milwaukee_blocks, aes(fill = transport, color=transport)) +  
  geom_sf(lwd=0.01, color='black') +
  theme_bw() +
  theme(legend.position = 'top', axis.text = element_blank(), axis.ticks = element_blank(),
        panel.grid.major = element_blank(), text = element_text(size = 12)) +
  guides(fill = guide_legend(title = 'Transport Type')) +
  scale_fill_brewer(palette = 'Dark2')
p

```


This analysis is performed twice. First, we do this on each individual trolley
route and bus route. This allows us to estimate the total population served by 
each route. However, this creates an issue of multiple counting - a particular
block can be (and often is) served by multiple bus and trolley lines. These estimates
are useful for comparing line by line, but not for aggregation.

To examine fully aggregated results, we combine the route geometries into a single
geom and take the union of each route. Once this is complete, we repeat the 
route by route analysis for the aggregated polygon. This yields an estimate 
of population served without the problem of multi counting.

# Results

Simple overlays of the historical streetcar routes and modern bus routes show 
a strong overlap between the systems. In fact, there are no census blocks in Milwaukee
that are covered by a historical trolley route but not by a modern bus route.
Buses completely supplanted the streetcar in Milwaukee, and newer bus routes extend well beyond
the historical trolley network.

This finding is expected, but interesting nonetheless. In terms of the physical routes involved, the 21st 
century bus lines should be offering the same mobility to residents that the older lines did. This does not
confirm that levels of service were identical in the years following the dismantling of the trolley system,
since our particular snapshots of the data are separated by around 100 years. We can conclude, however,
that the bus lines have been built to service the central city, and by extension, that service
to central Milwaukee remains a high priority for the transit network.


```{r total_transport_counts, fig.pos='here'}
trolleyRouteLength <- sum(st_length(trolleyRoutes))
busRouteLength <- sum(st_length(busRoutes))
routeLenDT <- data.table(
    'transport' = c('Trolley', 'Bus'),
    'len' = as.numeric(c(trolleyRouteLength, busRouteLength)/1000)
)

allTransportBlocks <- as.data.table(rbind(adjustedData$trolley_total, adjustedData$bus_total))
transportSummary <- allTransportBlocks[, .(
  # 'Block Count' = .N,
  'Population' = sum(pop10_adj),
  'Pop/Line' = sprintf('%i', round(sum(pop10_adj)/max(lineCount), 0))
), by = c('transport')]
transportSummary <- merge(transportSummary, routeLenDT, by = c('transport'))
transportSummary[, pop_p_km := Population/len]
# routeLengths <- rbindlist(list(trolleyDT, busDT), use.names = TRUE, fill = TRUE)
# routeLengths[, max(len), by = c('route_id', 'transport')]
kable(transportSummary[, .(transport, Population, `Pop/Line`, len, pop_p_km)], format = 'latex', caption = 'Total population served by trolley network of 1917 and modern bus routes. Population per line and per kilometer is rounded to nearest integer.', digits = 0, col.names = c('Mode', 'Pop', 'Pop/Line', 'Route-Km', 'Pop/Km'))
```

Examining the lines in more detail adds some color on the interplay between new routes and old. At the highest level buses serve `r sprintf('%0.0f', ((transportSummary[transport == 'Bus', Population] - transportSummary[transport == 'Trolley', Population])/transportSummary[transport == 'Bus', Population])*100)` 
percent more people than trolleys, but with `r sprintf('%0.0f', ((transportSummary[transport == 'Bus', len] - transportSummary[transport == 'Trolley', len])/transportSummary[transport == 'Bus', len])*100)` 
percent more route-kilometers. This would seem to indicate
that although more people are served by bus routes than the older trolley routes, and overlay the old routes, the new routes that have been added serve a small number of additional people. 

```{r, echo = FALSE, fig.cap = 'Kernel density estimation and two sample t-test comparing population density of census blocks served by a trolley line and those served exclusively by a bus line.', message=FALSE, warning=FALSE, fig.pos='here'}
separateBlockTransportData <- allTransportBlocks[transport == 'Trolley' | (transport == 'Bus' & gid %in% onlyBus)]
separateBlockTransportData[, ppl_square_km := as.numeric(pop10/(area/1000^2))]

busTrolleyTest <- t.test(
    separateBlockTransportData[transport == 'Trolley', ppl_square_km], 
    separateBlockTransportData[transport == 'Bus', ppl_square_km]
)

reportResult <- c(busTrolleyTest$estimate, busTrolleyTest$statistic, busTrolleyTest$p.value)
names(reportResult) <- c('Trolley Mean', 'Bus Mean', 't-statistic', 'p-value')

ggplot(data = separateBlockTransportData, aes(x = ppl_square_km, fill = transport)) +
    geom_density(alpha = 0.75) +
    scale_x_log10() +
    theme_bw() +
    scale_fill_brewer(palette = 'Dark2')  +
    annotate('text', x = 5, y = 1.0, 
             label = paste0(sprintf('%s: %0.02f', names(reportResult), reportResult), collapse='\n'), 
             hjust=0) +
    theme(axis.title.y = element_blank()) +
    xlab(bquote('People/km'^2)) +
    guides(fill = guide_legend(title = 'Transport Mode'))

```

To test this, we will compare our trolley-served blocks against those census blocks served only by bus 
routes. Because the census create blocks to have roughly equal population but with varying size, 
we divide the population of a block by the area of the block to get the population density. 
The differences between these two groups are highly significant. Census blocks with access to a trolley route,
on average, have a density of `r sprintf('%0.0f', reportResult['Trolley Mean'])` people per kilometer; by
comparison, bus routes have an average density of 
`r sprintf('%0.0f', reportResult['Bus Mean'])` (`r sprintf('%0.0f', ((reportResult['Trolley Mean'] - reportResult['Bus Mean'])/reportResult['Trolley Mean'])*100)` percent higher).

This is a somewhat obvious finding, but the degree is of concentration between downtown and the outlying
census blocks served by buses is unexpectedly high. Though the population of Milwaukee has spread out
to suburban areas like most American cities, it is still that the largest proportion of people served
by transit are concetrated in the core of the city. 

<!-- Across the city, transit lines are not generally very concentrated, though the population served is  -->
<!-- more concentrated among trolley routes than bus routes. In this case -->

```{r lorenz_distributions, fig.cap="Lorenz Curves by travel mode. This methodology double counts population that is served by multiple lines, but does so equally across modes. Trolley lines are slightly more concentrated.", include = FALSE}

plotData <- as.data.table(routePopDT)

dissimilarityIndex <- function(x) {
  pct_y <- x/sum(x)
  pct_x <- 1/length(x)
  0.5 * sum(abs(pct_y - pct_x))
}

lorenzData <- plotData[
  ][order(`Pop Served`), .SD, by = 'transport'
  ][, .(
    'id_pct' = 1:.N,
    'pop_pct' = cumsum(`Pop Served`)/sum(`Pop Served`),
    'total_count' = .N
  ), by = c('transport')
  ][, .(transport, 'id_pct' = id_pct/total_count, pop_pct)
]

indices <- plotData[, dissimilarityIndex(`Pop Served`), by = 'transport']
indexText <- sprintf(
  'Dissimilarity Indices:\nBus - %0.03f\nTrolley - %0.03f', 
  indices[transport == 'Bus', V1], 
  indices[transport == 'Trolley', V1]
)
ggplot(data = lorenzData, aes(x=id_pct, y = pop_pct, col = transport)) +
  geom_line() +
  scale_color_brewer(palette = 'Dark2') +
  scale_x_continuous(labels = scales::percent_format()) +
  scale_y_continuous(labels = scales::percent_format()) +
  theme_bw() +
  theme(axis.title = element_blank()) +
  guides(color = guide_legend(title = 'Mode')) +
  annotate(geom = 'text', x = 0.2, y = 0.6, label=indexText, hjust=0)
```



TODO: add historical statistics around light rail utilization here;

* What percentage of the population of Milwaukee area used to be served by public transit?
  * Consider TOTAL population of Milwaukee in 1917
  * Compare against TOTAL Milwaukee MSA in 2010
  * Plot Lorentz curve for concentration amount routes
  * Predict higher concentration for bus routes
  * Check against CSA and maybe just Milwaukee county

# Discussion

START a discussion on the merits/benefits/ and literature around light rail here.

When considering these historical streetcar lines, there are two ways to consider them. First,
we may examine the role of old streetcars in the context of a modern population. Next, we may
also consider a modern light rail system overlaid upon the historical streetcar system.

* What were the findings?
* What conclusions can we draw about the layout of cities and the requirements of new light rail projects?
* In what ways would historical routes provide higher or lower levels of service in modern context?

The mode share is not the important part. The determination of service is dependent on the 
spatial organization of people and activities more than what transit option is provided.
Considering that modern bus routes very often follow or overlap with the historical trolley routes,
the same corridors have remained important over time. Yet the relative important of these corridors to the
rest of the city has clearly declined, as we see in the deconcentration of passengers within lines. Bus routes
in the Milwaukee region carry considerably more people in total, yet have a nearly {insert pct here}% decrease
in riders per line.

When transit planners advocate for new rail to revitalize a downtown area, this seems more like a way to
put a positive, progressive spin on a less popular, but equally important idea - transportation is most
effective when it goes where people are, and rather than incur the massive expense of expanding transportation
lines further and further out of the city, density can be increased to bring more people close 
to transportation options. That is to say, even if Milwaukee's trolley's had never been ripped up and
replaced with buses, total ridership would have declined and new rails would have had to be built into 
the growing suburban areas outside the city.


# Conclusion

The hollowing out of American cities will not be undone by a revolution in light rail.

# References
